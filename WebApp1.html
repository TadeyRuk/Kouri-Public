<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kouri — Liquid Glass AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{
      --bg: #0b0f1a;
      --gradient-1: #1a73e8;
      --gradient-2: #a855f7;
      --accent: #7aa7ff;
      --glass-fill: rgba(255,255,255,0.08);
      --glass-stroke: rgba(255,255,255,0.22);
      --glass-highlight: rgba(255,255,255,0.65);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.6);
      --shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
      --blur: 20px;
      --pad: 16px;
      --panel-gap: clamp(10px, 1.8vmin, 18px);
      --chat-max: 900px;
      --bubble-in: 220ms cubic-bezier(.2,.8,.2,1);
      --float: 14s cubic-bezier(.3,.6,.3,1) infinite alternate;
      --ring: 0 0 0 0 rgba(122,167,255,0);
    }

    @media (prefers-color-scheme: light) {
      :root{
        --bg: #f2f4f8;
        --glass-fill: rgba(255,255,255,0.6);
        --glass-stroke: rgba(0,0,0,0.07);
        --text: rgba(0,0,0,0.86);
        --muted: rgba(0,0,0,0.6);
        --shadow: 0 8px 24px rgba(17,24,39,0.14), inset 0 1px 0 rgba(255,255,255,0.9);
      }
    }

    html, body{
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    body{
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(1200px 1200px at 10% -10%, rgba(26,115,232,0.25), transparent 40%),
                  radial-gradient(1000px 900px at 110% 0%, rgba(168,85,247,0.22), transparent 50%),
                  radial-gradient(600px 700px at 50% 120%, rgba(16,185,129,0.18), transparent 60%),
                  var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    /* Ambient floating orbs */
    .orbs{
      position: fixed; inset: -20vmax;
      filter: blur(60px) saturate(130%);
      pointer-events: none; z-index: 0;
    }
    .orb{
      position: absolute; width: 36vmax; height: 36vmax; border-radius: 50%;
      background: radial-gradient(closest-side, rgba(122,167,255,.26), transparent 70%);
      animation: floatY var(--float);
      mix-blend-mode: screen;
    }
    .orb:nth-child(2){
      background: radial-gradient(closest-side, rgba(168,85,247,.25), transparent 70%);
      top: 20%; left: 55%; animation-delay: -4s;
    }
    .orb:nth-child(3){
      background: radial-gradient(closest-side, rgba(56,189,248,.22), transparent 70%);
      top: 60%; left: 10%; animation-delay: -8s;
    }
    @keyframes floatY{ to { transform: translateY(-6vmax) translateX(2vmax) } }

    /* Noise overlay for glass realism */
    .noise{
      position: fixed; inset: -50vmax;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" opacity=".06"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
      background-size: 300px 300px;
      mix-blend-mode: soft-light;
      pointer-events: none; z-index: 1;
    }

    /* Shell */
    .app{
      position: relative; z-index: 2;
      width: min(100%, 1100px);
      height: 100dvh; /* great on iOS Safari */
      margin: 0 auto;
      display: grid;
      grid-template-rows: auto 1fr auto;
      padding: max(env(safe-area-inset-top), 16px) max(env(safe-area-inset-right), 16px) max(env(safe-area-inset-bottom), 16px) max(env(safe-area-inset-left), 16px);
      gap: var(--panel-gap);
      box-sizing: border-box;
    }

    .glass{
      background: linear-gradient(180deg, var(--glass-fill), color-mix(in oklab, var(--glass-fill), transparent 40%));
      border: 1px solid var(--glass-stroke);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur)) saturate(140%);
      -webkit-backdrop-filter: blur(var(--blur)) saturate(140%);
      position: relative;
      overflow: clip;
    }

    /* Header */
    .header{
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px 14px 12px;
      gap: 12px;
    }
    .brand{
      display: flex; align-items: center; gap: 12px; font-weight: 700; letter-spacing: .2px;
    }
    .avatar{
      width: 38px; height: 38px; border-radius: 50%;
      background: conic-gradient(from 180deg, rgba(122,167,255,.85), rgba(168,85,247,.85), rgba(56,189,248,.85), rgba(122,167,255,.85));
      position: relative;
      box-shadow: 0 6px 18px rgba(122,167,255,0.35), inset 0 0 0 2px rgba(255,255,255,.4);
    }
    .avatar::after{
      content: ""; position: absolute; inset: 2px; border-radius: 50%;
      background: radial-gradient(circle at 70% 30%, rgba(255,255,255,.85), rgba(255,255,255,.2) 40%, transparent 60%);
      filter: blur(2px);
    }
    .chip{
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--glass-stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
      font-size: 13px; color: var(--muted);
      user-select: none;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: radial-gradient(circle at 40% 40%, var(--glass-highlight), rgba(122,167,255,.9));
      box-shadow: 0 0 12px rgba(122,167,255,.8);
      animation: pulse 2.2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); box-shadow: 0 0 10px rgba(122,167,255,.5) }
      50%{ transform: scale(1.2); box-shadow: 0 0 22px rgba(122,167,255,.9) }
    }

    /* Chat area */
    .chat{
      display: grid; grid-template-rows: 1fr;
      min-height: 0;
    }
    .scroll{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 18px;
      display: flex; flex-direction: column; gap: 12px;
      scroll-behavior: smooth;
    }
    .scroll::-webkit-scrollbar{ width: 0; height: 0 }
    .timeline{
      width: 100%;
      margin: 0 auto;
      max-width: var(--chat-max);
      display: flex; flex-direction: column; gap: 14px;
    }
    .msg{
      display: flex; gap: 10px; align-items: flex-end;
      opacity: 0; transform: translateY(10px) scale(.98);
      animation: in var(--bubble-in) forwards;
    }
    @keyframes in{ to { opacity: 1; transform: translateY(0) scale(1) } }
    .bubble{
      max-width: min(80%, 720px);
      padding: 12px 14px;
      border-radius: 18px;
      line-height: 1.35;
      backdrop-filter: blur(14px) saturate(150%);
      -webkit-backdrop-filter: blur(14px) saturate(150%);
      border: 1px solid var(--glass-stroke);
      position: relative;
      box-shadow: 0 8px 20px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.18);
      word-wrap: break-word; white-space: pre-wrap;
    }
    .bubble::before{
      content: "";
      position: absolute; inset: 0;
      border-radius: inherit;
      background: radial-gradient(120% 180% at -10% -10%, rgba(255,255,255,.18), transparent 40%),
                  linear-gradient(180deg, rgba(255,255,255,.12), transparent 60%);
      pointer-events: none;
    }
    .user .bubble{
      margin-left: auto;
      border-top-right-radius: 6px;
      background: linear-gradient(180deg, rgba(122,167,255,.32), rgba(122,167,255,.18));
      color: var(--text);
      outline: 1px solid rgba(122,167,255,.5);
      text-shadow: 0 1px 0 rgba(0,0,0,.2);
    }
    .ai .bubble{
      margin-right: auto;
      border-top-left-radius: 6px;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.12));
    }
    .meta{
      font-size: 12px; color: var(--muted);
      margin: 2px 6px;
    }
    .typing{
      display: inline-flex; gap: 6px; align-items: center;
      padding: 10px 12px;
    }
    .typing i{
      display: inline-block; width: 6px; height: 6px; border-radius: 50%;
      background: rgba(255,255,255,.8);
      opacity: .6;
      animation: bounce 1s ease-in-out infinite;
    }
    .typing i:nth-child(2){ animation-delay: .15s }
    .typing i:nth-child(3){ animation-delay: .3s }
    @keyframes bounce{
      0%,100%{ transform: translateY(0); opacity: .6 }
      50%{ transform: translateY(-6px); opacity: 1 }
    }

    /* Composer */
    .composer{
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
      padding: 12px;
      position: relative;
    }
    .field{
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-lg);
      background: linear-gradient(180deg, rgba(255,255,255,.3), rgba(255,255,255,.18));
      border: 1px solid var(--glass-stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px) saturate(150%);
      -webkit-backdrop-filter: blur(16px) saturate(150%);
      transition: box-shadow .25s ease, transform .25s ease;
    }
    .field:focus-within{
      box-shadow: 0 16px 36px rgba(122,167,255,.34), inset 0 1px 0 rgba(255,255,255,.3);
      transform: translateY(-1px);
      outline: 1px solid rgba(122,167,255,.4);
    }
    textarea{
      flex: 1;
      min-height: 24px; max-height: 140px;
      resize: none; border: 0; outline: 0; background: transparent;
      font: 16px/1.35 -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      color: var(--text);
    }
    .btn{
      appearance: none; -webkit-appearance: none;
      border: 0; outline: 0; cursor: pointer;
      padding: 12px 16px;
      border-radius: 14px;
      font-weight: 600;
      background: linear-gradient(180deg, color-mix(in oklab, var(--accent), white 10%), var(--accent));
      color: #0b1220;
      box-shadow: 0 8px 16px rgba(122,167,255,.45), inset 0 1px 0 rgba(255,255,255,.6);
      transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:disabled{
      filter: saturate(.2) contrast(.9) grayscale(.2) opacity(.7);
      cursor: not-allowed;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.5);
    }
    .btn:active{ transform: translateY(1px) scale(.99) }

    /* Scroll-to-bottom affordance */
    .toBottom{
      position: absolute; right: 18px; bottom: calc(100% + 8px);
      padding: 8px 12px; border-radius: 999px;
      font-size: 13px; color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      border: 1px solid var(--glass-stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      opacity: 0; transform: translateY(10px); pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
    }
    .toBottom.show{ opacity: 1; transform: translateY(0); pointer-events: auto }

    /* Decorative ring highlights on panels */
    .glass::after{
      content: "";
      position: absolute; inset: 0;
      border-radius: inherit;
      background: conic-gradient(from 0deg, rgba(122,167,255,.22), rgba(168,85,247,.18), rgba(56,189,248,.18), rgba(122,167,255,.22));
      mask: radial-gradient(farthest-side, transparent calc(100% - 2px), black 100%);
      opacity: .35; pointer-events: none;
    }

    /* Responsiveness */
    @media (max-width: 720px){
      .header{ padding: 12px }
      .composer{ padding: 10px }
      .bubble{ max-width: 88% }
      .btn{ padding: 12px 14px }
      .avatar{ width: 34px; height: 34px }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="orbs">
    <div class="orb" style="top: 5%; left: 5%"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>
  <div class="noise"></div>

  <main class="app">
    <header class="glass header">
      <div class="brand">
        <div class="avatar" aria-hidden="true"></div>
        <div>
          <div style="font-size:17px; font-weight:800; letter-spacing:.3px">Kouri</div>
          <div style="font-size:12px; color:var(--muted)">Your personal AI, in liquid glass</div>
        </div>
      </div>
      <div class="chip"><span class="dot"></span> Ready</div>
    </header>

    <section class="glass chat">
      <div id="scroll" class="scroll">
        <div id="timeline" class="timeline">
          <div class="msg ai">
            <div class="bubble">
              Hey! I’m <strong>Kouri</strong>. Ask me anything and I’ll answer with classy glass ✨
            </div>
          </div>
        </div>
      </div>
      <button id="toBottom" class="toBottom" aria-label="Scroll to latest">Jump to latest</button>
    </section>

    <footer class="glass composer">
      <div class="field">
        <textarea id="input" rows="1" placeholder="Message Kouri…" autocomplete="off"></textarea>
      </div>
      <button id="send" class="btn" disabled>
        Send
      </button>
    </footer>
  </main>

  <script>
    const el = {
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      timeline: document.getElementById('timeline'),
      scroll: document.getElementById('scroll'),
      toBottom: document.getElementById('toBottom')
    };

    let typingEl = null;

    // Auto-resize textarea
    const autoSize = () => {
      el.input.style.height = 'auto';
      el.input.style.height = Math.min(el.input.scrollHeight, 140) + 'px';
    };
    el.input.addEventListener('input', () => {
      autoSize();
      el.send.disabled = !el.input.value.trim();
    });

    // Enter to send; Shift+Enter for newline
    el.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        trySend();
      }
    });

    el.send.addEventListener('click', trySend);

    // Scroll-to-bottom affordance
    const atBottom = () => {
      const near = el.scroll.scrollTop >= (el.scroll.scrollHeight - el.scroll.clientHeight - 20);
      return near;
    };
    const showToBottom = () => {
      el.toBottom.classList.toggle('show', !atBottom());
    };
    el.scroll.addEventListener('scroll', showToBottom);
    el.toBottom.addEventListener('click', () => {
      el.scroll.scrollTop = el.scroll.scrollHeight;
    });

    function addMessage(text, who = 'ai'){
      const wrap = document.createElement('div');
      wrap.className = `msg ${who}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      wrap.appendChild(bubble);
      el.timeline.appendChild(wrap);
      requestAnimationFrame(() => el.scroll.scrollTop = el.scroll.scrollHeight);
      if (who === 'ai') chime(); else haptic();
    }

    function showTyping(){
      if (typingEl) return;
      const wrap = document.createElement('div');
      wrap.className = 'msg ai';
      const bubble = document.createElement('div');
      bubble.className = 'bubble typing';
      bubble.innerHTML = '<i></i><i></i><i></i>';
      wrap.appendChild(bubble);
      typingEl = wrap;
      el.timeline.appendChild(typingEl);
      el.scroll.scrollTop = el.scroll.scrollHeight;
    }
    function hideTyping(){
      if (!typingEl) return;
      typingEl.remove();
      typingEl = null;
    }

    async function trySend(){
      const text = el.input.value.trim();
      if (!text) return;
      el.send.disabled = true;
      addMessage(text, 'user');
      el.input.value = '';
      autoSize();
      showTyping();

      try{
        const reply = await routeTask(text);
        hideTyping();
        addMessage(reply, 'ai');
      }catch(err){
        hideTyping();
        addMessage("Hmm, I couldn't reach the server. Here's a quick local reply while you connect:\n\n“" + localFallback(text) + "”", 'ai');
        console.error(err);
      }finally{
        el.send.disabled = false;
        showToBottom();
      }
    }

    // Integration-ready: POST to /route_task -> { reply: "..." }
    async function routeTask(prompt){
      const res = await fetch('/route_task', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ prompt })
      });
      if (!res.ok) throw new Error('Bad response');
      const data = await res.json();
      // Accept flexible field names
      return data.reply ?? data.message ?? data.text ?? JSON.stringify(data);
    }

    // Local graceful fallback if backend is not running
    function localFallback(input){
      const answers = [
        "Got it! When your backend is live, I’ll fetch real answers.",
        "On brand, on glass. Connect /route_task for full power.",
        "Echo: " + input,
        "Tip: long-press Space on iOS to move the caret precisely."
      ];
      return answers[Math.floor(Math.random()*answers.length)];
    }

    // Subtle sound on AI message (Web Audio API)
    function chime(){
      if (!window.AudioContext) return;
      const ctx = chime.ctx || (chime.ctx = new AudioContext());
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      const now = ctx.currentTime;
      o.frequency.setValueAtTime(660, now);
      o.frequency.exponentialRampToValueAtTime(990, now + 0.13);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.03, now + 0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);
      o.connect(g).connect(ctx.destination);
      o.start(now);
      o.stop(now + 0.24);
    }

    // Gentle haptic on send (if available)
    function haptic(){
      if (navigator.vibrate) navigator.vibrate(8);
    }

    // Welcome hint after load
    window.addEventListener('load', () => {
      autoSize();
      setTimeout(() => {
        addMessage("Pro tip: Press ⌘ + Enter (or tap Send) to submit. Shift + Enter adds a new line.");
      }, 250);
    });

    // Improve iOS Safari keyboard handling
    window.addEventListener('focusin', (e) => {
      if (e.target === el.input) setTimeout(() => el.scroll.scrollTop = el.scroll.scrollHeight, 100);
    });
  </script>
</body>
</html>
